<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:p="http://primefaces.org/ui"
	xmlns:c="http://java.sun.com/jsp/jstl/core">


	<script type="text/javascript">
		// disables the autofocus for the caseHistoryOverlayplpanel 
		(function() {
			var proxied = PrimeFaces.widget.OverlayPanel.prototype.applyFocus;

			PrimeFaces.widget.OverlayPanel.prototype.applyFocus = function() {
				if (this.id == "contentForm:caseHistoryOverlayPanel")
					return;

				return proxied.apply(this, arguments);
			};
		})();
	</script>

	<ui:include src="common/navigationBar.xhtml"></ui:include>

	<c:set var="selectedTask"
		value="#{commonDataHandlerAction.selectedTask}" />

	<c:set var="taskEditable" scope="session"
		value="#{taskStatusHandler.isTaskEditable(selectedTask)}" />

	<p:panel style="width: 80%"
		styleClass="collapsedBorders noPadding noBorders">

		<h:outputLabel value="#{msg['body.diagnosis.headline']}"
			style="font-size:1.5em;"></h:outputLabel>


		<h:panelGrid columns="3" style="margin-top:10px;"
			styleClass="defaultListingTableTwoLineContainer">

			<!-- Left Column -->
			<h:panelGrid columns="1" styleClass="defaultListingTableContainer">
				<!-- material -->
				<h:panelGrid columns="2" styleClass="defaultListingTableFirstColumEnummeration"
					columnClasses="defaultListingTableColumnTop,">

					<h:outputLabel value="#{msg['body.diagnosis.material']}" />

					<h:panelGrid columns="1" styleClass="defaultListingTableContainer"
						style="width:410px">
						<c:forEach items="#{selectedTask.samples}" var="sample"
							varStatus="loopCount">

							<h:panelGrid columns="3"
								styleClass="defaultListingTableContainer">

								<h:outputLabel
									value="#{msg['body.diagnosis.diagnosis.sample']} #{sample.sampleID}" />

								<p:inputText value="#{sample.material}"
									disabled="#{!taskEditable}" tabindex="1"
									styleClass="smallInput customBackground"
									style="width:200px;float:right;background:##{userHandlerAction.currentUser.inputFieldColor};color:##{userHandlerAction.currentUser.inputFieldFontColor}" />

								<p:commandLink tabindex="1"
									title="#{msg['body.receiptlog.notification.hint']}"
									rendered="#{taskEditable}"
									style="float: right; margin-right:5px;"
									actionListener="#{dialogHandlerAction.changeMaterialDialog.initAndPrepareBean(sample)}">
									<i class="fa fa-fw fa-cog" />
									<p:ajax event="dialogReturn"
										update="navigationForm contentForm" />
								</p:commandLink>
							</h:panelGrid>
						</c:forEach>
					</h:panelGrid>
					<!-- Eye -->
					<h:outputLabel value="#{msg['body.diagnosis.eye']}" />
					<p:selectOneMenu styleClass="smallInput customBackground"
						tabindex="6"
						style="background:##{userHandlerAction.currentUser.inputFieldColor};color:##{userHandlerAction.currentUser.inputFieldFontColor}"
						disabled="#{!taskEditable}" value="#{selectedTask.eye}">

						<f:selectItems value="#{enumProvider.eyes}" var="eye"
							itemLabel="#{msg['enum.eye.'.concat(eye)]}" itemValue="#{eye}" />

						<p:ajax event="change" execute="@this"
							listener="#{diagnosisViewHandlerAction.onDataChange(selectedTask,'log.patient.task.change.eye',selectedTask.eye)}" />
					</p:selectOneMenu>
					<!-- Eye -->
				</h:panelGrid>
				<!-- material -->

				<h:panelGrid columns="1" styleClass="defaultListingTableFirstColumEnummeration">
					<h:outputLabel value="#{msg['body.diagnosis.story']}" />
					<h:panelGroup>

						<p:inputTextarea value="#{selectedTask.caseHistory}"
							title="#{msg['body.diagnosis.story.watermark']}"
							disabled="#{!taskEditable}" id="caseHistoryInput"
							style="width:90%" onfocus="PF('caseHistoryOverlayPanel').show();"
							onkeypress="PF('caseHistoryOverlayPanel').hide();"
							onclick="PF('caseHistoryOverlayPanel').show();">
							<p:ajax event="change"
								listener="#{diagnosisViewHandlerAction.onDataChange(commonDataHandlerAction.selectedTask,'log.patient.task.change.caseHistory',commonDataHandlerAction.selectedTask.caseHistory)}"></p:ajax>
						</p:inputTextarea>

						<p:overlayPanel id="caseHistoryOverlayPanel"
							styleClass="defaultOverlayPanel" for="caseHistoryInput"
							widgetVar="caseHistoryOverlayPanel" hideEffect="fade"
							style="width:500px" hideEvent="none" showEvent="none">
							<p:dataTable
								value="#{diagnosisViewHandlerAction.caseHistoryList}" var="item"
								styleClass="smallDatatable highlightedDataTable noBordersAll"
								scrollable="true" scrollHeight="200" rowKey="#{item.id}"
								selection="#{diagnosisViewHandlerAction.selectedCaseHistoryItem}"
								selectionMode="single">
								<p:column filterBy="#{item.value}" filterMatchMode="contains">
									<h:outputText value="#{item.value}" />
								</p:column>

								<p:ajax event="rowSelect" update="contentForm:caseHistoryInput"
									listener="#{diagnosisViewHandlerAction.copyCaseHistory(selectedTask, diagnosisViewHandlerAction.selectedCaseHistoryItem)}"
									oncomplete="PF('caseHistoryOverlayPanel').hide();" />
							</p:dataTable>

						</p:overlayPanel>
					</h:panelGroup>
				</h:panelGrid>

			</h:panelGrid>
			<!-- Left Column -->

			<h:panelGroup />

			<!-- Right Column -->
			<h:panelGrid columns="1" styleClass="defaultListingTableContainer">
				<h:panelGrid columns="2" styleClass="defaultListingTableFirstColumEnummeration">
					<!-- date of surgery -->
					<h:outputLabel value="#{msg['body.diagnosis.surgeryDate']}" />
					<p:calendar pattern="dd.MM.yyyy" mask="true" tabindex="2"
						style="background:##{userHandlerAction.currentUser.inputFieldColor};color:##{userHandlerAction.currentUser.inputFieldFontColor}"
						styleClass="customBackground" disabled="#{!taskEditable}"
						value="#{selectedTask.dateOfSugeryAsDate}">
						<p:ajax event="dateSelect"
							listener="#{diagnosisViewHandlerAction.onDataChange(selectedTask,'log.patient.task.change.dateOfSurgery',mainHandlerAction.date(selectedTask.dateOfSugeryAsDate))}" />
						<f:ajax event="change" execute="@this"
							listener="#{diagnosisViewHandlerAction.onDataChange(selectedTask,'log.patient.task.change.dateOfSurgery',mainHandlerAction.date(selectedTask.dateOfSugeryAsDate))}" />
					</p:calendar>

					<!-- date of receipt -->
					<h:outputLabel value="#{msg['body.diagnosis.taskEDate']}" />
					<p:calendar pattern="dd.MM.yyyy" mask="true" tabindex="3"
						disabled="#{!taskEditable}"
						style="background:##{userHandlerAction.currentUser.inputFieldColor};color:##{userHandlerAction.currentUser.inputFieldFontColor}"
						styleClass="customBackground"
						value="#{selectedTask.dateOfReceiptAsDate}">
						<p:ajax event="dateSelect"
							listener="#{diagnosisViewHandlerAction.onDataChange(selectedTask,'log.patient.task.change.receiptDate',mainHandlerAction.date(selectedTask.dateOfReceiptAsDate))}" />
						<f:ajax event="change" execute="@this"
							listener="#{diagnosisViewHandlerAction.onDataChange(selectedTask,'log.patient.task.change.receiptDate',mainHandlerAction.date(selectedTask.dateOfReceiptAsDate))}" />
					</p:calendar>

					<!-- Task Number -->
					<h:outputLabel value="#{msg['body.diagnosis.taskNumber']}" />
					<p:inputText disabled="true" value="#{selectedTask.taskID}" />

					<!-- insurance -->
					<h:outputLabel value="#{msg['body.diagnosis.insurance']}" />

					<p:selectOneButton disabled="#{!taskEditable}" tabindex="4"
						value="#{commonDataHandlerAction.selectedPatient.privateInsurance}">
						<f:selectItem
							itemLabel="#{msg['body.diagnosis.insurance.private']}"
							itemValue="#{false}]" />
						<f:selectItem
							itemLabel="#{msg['body.diagnosis.insurance.normal']}"
							itemValue="#{true}" />
						<p:ajax event="change"
							listener="#{diagnosisViewHandlerAction.onDataChange(commonDataHandlerAction.selectedPatient,'log.patient.task.change.insurance', commonDataHandlerAction.selectedPatient.privateInsurance)}" />
					</p:selectOneButton>

					<!-- ward -->
					<h:outputLabel value="#{msg['body.diagnosis.ward']}" />
					<p:selectOneMenu id="wards" value="#{selectedTask.ward}"
						editable="true" disabled="#{!taskEditable}"
						styleClass="customBackground" tabindex="5"
						style="background:##{userHandlerAction.currentUser.inputFieldColor};color:##{userHandlerAction.currentUser.inputFieldFontColor}">

						<f:selectItems value="#{diagnosisViewHandlerAction.wardList}"
							itemValue="#{ward.value}" itemLabel="#{ward.value}" var="ward" />
						<p:ajax event="change" execute="@this"
							listener="#{diagnosisViewHandlerAction.onDataChange(selectedTask,'log.patient.task.change.ward', selectedTask.ward)}" />
					</p:selectOneMenu>

					<!-- surgeon -->
					<h:panelGroup layout="block" style="margin: 6px 0px 3px 0px;">
						<h:outputLabel value="#{msg['body.diagnosis.surgeon']}" />
					</h:panelGroup>

					<h:panelGroup layout="block" style="margin: 6px 0px 3px 0px;">
						<h:outputLabel style="margin-left:10px;"
							value="#{selectedTask.getPrimaryContact('SURGEON')}"></h:outputLabel>

						<!-- quickContact surgeon -->
						<p:commandLink style="float: right; margin-right:5px;"
							styleClass="noUnderlineAtLink" tabindex="8"
							title="#{msg['body.receiptlog.notification.surgeon.hint']}"
							actionListener="#{dialogHandlerAction.contactSelectDialog.initAndPrepareBean(commonDataHandlerAction.selectedTask,'SURGEON')}"
							disabled="#{!taskEditable}">
							<i class="fa fa-fw fa-scissors" />
							<p:ajax event="dialogReturn" update="navigationForm contentForm" />
						</p:commandLink>
					</h:panelGroup>

					<h:panelGroup layout="block" style="margin: 6px 0px 3px 0px;">
						<h:outputLabel value="#{msg['body.diagnosis.privatePhysician']}"></h:outputLabel>
					</h:panelGroup>

					<h:panelGroup layout="block" style="margin: 6px 0px 3px 0px;">
						<h:outputLabel style="margin-left:10px;"
							value="#{selectedTask.getPrimaryContact('PRIVATE_PHYSICIAN')}"></h:outputLabel>

						<!-- quickcontact private physician  -->
						<p:commandLink style="float: right; margin-right:5px;"
							styleClass="noUnderlineAtLink" tabindex="9"
							title="#{msg['body.receiptlog.notification.ophthalmologist.hint']}"
							actionListener="#{dialogHandlerAction.contactSelectDialog.initAndPrepareBean(commonDataHandlerAction.selectedTask,'PRIVATE_PHYSICIAN')}"
							disabled="#{!taskEditable}">
							<i class="fa fa-fw fa-eye" />
							<p:ajax event="dialogReturn" update="navigationForm contentForm" />
						</p:commandLink>

					</h:panelGroup>

				</h:panelGrid>
			</h:panelGrid>
			<!-- Right Column -->

		</h:panelGrid>

		<p:separator />

		<!-- Diagnoses -->
		<ui:repeat var="revision"
			value="#{selectedTask.diagnosisContainer.diagnosisRevisions}">

			<h:panelGrid columns="2" styleClass="defaultListingTableFirstColumEnummeration"
				columnClasses="defaultListingTableColumnTop,">
				<!-- Extended Diagnosis Text -->
				<h:outputLabel value="#{revision.name}"></h:outputLabel>
				<h:panelGroup id="extendedTextParent">
					<p:inputTextarea style="width:100%" id="extendedText" rows="15"
						disabled="#{!taskEditable}" value="#{revision.text}">

						<p:ajax event="change" execute="@this"
							listener="#{diagnosisViewHandlerAction.onDataChange(revision,'log.patient.task.change.histologicalRecord', revision.text)}" />
					</p:inputTextarea>


					<p:commandButton style="display:none" id="submitDiagnosisChange"
						name="submitDiagnosisChange" process="extendedTextParent"></p:commandButton>
				</h:panelGroup>

				<!-- Diagnosis for sample -->
				<h:outputLabel value="#{msg['body.diagnosis.diagnoses']}"></h:outputLabel>
				<ui:repeat var="diagnosis" value="#{revision.diagnoses}">
					<h:panelGrid columns="3" styleClass="defaultListingTableContainer"
						columnClasses="defaultListingTableColumn15,">
						<!-- sample -->
						<h:outputLabel
							value="#{msg['body.diagnosis.diagnosis.sample']} #{diagnosis.sample.sampleID}"></h:outputLabel>

						<h:panelGrid columns="2" styleClass="defaultListingTableContainer">
							<!-- diagnosis category -->
							<p:selectOneMenu value="#{diagnosis.diagnosisPrototype}"
								styleClass="customSerachSelectMenu" disabled="#{!taskEditable}"
								panelStyleClass="customSerachSelectMenuPanel"
								converter="#{diagnosisViewHandlerAction.diagnosisPresetsTransformer}"
								filter="true" filterMatchMode="startsWith">
								<f:selectItem
									itemLabel="#{msg['body.receiptlog.tab.diangonsis.data.diangosis.choose']}"
									itemValue="#{null}" />

								<f:selectItems
									value="#{diagnosisViewHandlerAction.diagnosisPresets}"
									var="diagnosisPrototype"
									itemLabel="#{diagnosisPrototype.diagnosis}"
									itemValue="#{diagnosisPrototype}" />

								<p:ajax event="change" update="contentForm"
									listener="#{diagnosisViewHandlerAction.onDiagnosisPrototypeChanged(diagnosis)}" />

							</p:selectOneMenu>

							<!-- copy diagnosis text -->
							<p:commandLink styleClass="noUnderlineAtLink"
								style="margin-left:20px;" disabled="#{!taskEditable}"
								title="#{msg['body.diagnosis.diagnosis.histologicalRecordPreset']}"
								rendered="#{diagnosis.diagnosisPrototype ne null}"
								actionListener="#{diagnosisViewHandlerAction.onCopyHistologicalRecord(diagnosis)}"
								update="contentForm">
								<i class="fa fa-hand-o-up"></i>
								<p:ajax event="dialogReturn" update="navigationForm contentForm" />
							</p:commandLink>
						</h:panelGrid>

						<!-- malign -->
						<h:panelGrid columns="2" style="float:right;margin-right:20px;"
							styleClass="verticalAlignMiddleAll">
							<h:outputLabel
								value="#{msg['body.receiptlog.tab.diangonsis.data.diangosis.malign']}" />
							<p:selectBooleanCheckbox value="#{diagnosis.malign}"
								disabled="#{!taskEditable}" style="margin:3px 0px 0px 3px;">

								<f:ajax event="change"
									listener="#{diagnosisViewHandlerAction.onDataChange(diagnosis,'log.patient.task.sample.diagnosis.changed.malign',diagnosis.malign)}" />
							</p:selectBooleanCheckbox>
						</h:panelGrid>
					</h:panelGrid>

					<h:panelGrid columns="2" styleClass="defaultListingTableContainer"
						style="width:100%" columnClasses="defaultListingTableColumn15,">
						<h:outputLabel />
						<!-- diagnosis text -->
						<p:inputTextarea value="#{diagnosis.diagnosis}" id="diagnosisText"
							disabled="#{!taskEditable}" style="width:100%">
							<p:watermark for="diagnosisText"
								value="#{msg['body.receiptlog.tab.diangonsis.data.diangosis.watermark']}" />
							<f:ajax event="change" execute="@this"
								listener="#{diagnosisViewHandlerAction.onDataChange(diagnosis,'log.patient.task.sample.diagnosis.changed.diagnosis.text',diagnosis.diagnosis)}" />
						</p:inputTextarea>
					</h:panelGrid>
					<!-- Diagnosis for sample -->
				</ui:repeat>
			</h:panelGrid>
		</ui:repeat>

		<p:separator />

		<h:panelGrid columns="3"
			styleClass="defaultListingTableTwoLineContainer">
			<!-- left column -->
			<h:panelGrid columns="2" styleClass="defaultListingTableFirstColumEnummeration">
				<!-- Date of signature -->
				<h:outputLabel
					value="#{msg['body.receiptlog.tab.diangonsis.data.signature.date']}"></h:outputLabel>
				<p:calendar pattern="dd.MM.yyyy" mask="true"
					disabled="#{!taskEditable}"
					value="#{selectedTask.diagnosisContainer.signatureDateAsDate}">
					<p:ajax event="dateSelect"
						listener="#{diagnosisViewHandlerAction.onDataChange(selectedTask.diagnosisContainer,'log.patient.task.diagnosisContainer.signautre.date',mainHandlerAction.date(selectedTask.diagnosisContainer.signatureDate))}" />
					<f:ajax event="change" execute="@this"
						listener="#{diagnosisViewHandlerAction.onDataChange(selectedTask.diagnosisContainer,'log.patient.task.diagnosisContainer.signautre.date',mainHandlerAction.date(selectedTask.diagnosisContainer.signatureDate))}" />
				</p:calendar>
			</h:panelGrid>

			<h:panelGroup />

			<!-- right column -->
			<h:panelGrid columns="2" styleClass="defaultListingTableFirstColumEnummeration">

				<!-- physician -->
				<h:outputLabel
					value="#{msg['body.receiptlog.tab.diangonsis.data.signature.physician']}" />
				<h:panelGroup>
					<p:selectOneMenu disabled="#{!taskEditable}"
						styleClass="customSerachSelectMenu" style="width:80% !important;"
						panelStyleClass="customSerachSelectMenuPanel"
						value="#{diagnosisViewHandlerAction.signatureOne}"
						converter="#{diagnosisViewHandlerAction.physiciansToSignListTransformer}"
						filter="true" filterMatchMode="contains">

						<f:selectItem
							itemLabel="#{msg['body.receiptlog.tab.diangonsis.data.signature.physician.select']}"
							itemValue="#{null}" />

						<f:selectItems
							value="#{diagnosisViewHandlerAction.physiciansToSignList}"
							var="physician" itemLabel="#{physician.person.fullName}"
							itemValue="#{physician}" />

						<p:ajax event="change"
							onstart="$('#contentForm\\:submitPhysicianChange').click();" />

					</p:selectOneMenu>

					<p:commandButton style="display:none" update="@form"
						id="submitPhysicianChange">
						<f:actionListener
							binding="#{selectedTask.diagnosisContainer.setPhysicianAsSignatureOne(diagnosisViewHandlerAction.signatureOne)}" />
						<f:actionListener
							binding="#{diagnosisViewHandlerAction.onDataChange(selectedTask.diagnosisContainer,'log.patient.task.diagnosisContainer.signature.one',selectedTask.diagnosisContainer.signatureOne.physician.person.fullName)}" />
					</p:commandButton>
				</h:panelGroup>


				<h:panelGroup />

				<!-- physician role -->
				<h:panelGroup>
					<p:selectOneMenu styleClass="customSerachSelectMenu"
						id="pysicianToSignRole" editable="true"
						style="width:80% !important;" disabled="#{!taskEditable}"
						value="#{selectedTask.diagnosisContainer.signatureOne.role}">
						<f:selectItems value="#{enumProvider.signatureRoles}"
							var="signatureRole"
							itemLabel="#{msg['enum.signatureRole.'.concat(signatureRole)]}"
							itemValue="#{msg['enum.signatureRole.'.concat(signatureRole)]}" />
						<p:ajax event="change"
							onstart="$('#contentForm\\:submitPhysicianRoleChange').click();" />
					</p:selectOneMenu>

					<!-- hidden button for updating on physician role change -->

					<p:commandButton style="display:none" update="@form"
						id="submitPhysicianRoleChange">
						<f:actionListener
							binding="#{diagnosisViewHandlerAction.onDataChange(selectedTask.diagnosisContainer,'log.patient.task.diagnosisContainer.signature.one.role',selectedTask.diagnosisContainer.signatureOne.role)}" />
					</p:commandButton>
				</h:panelGroup>


				<h:outputLabel
					value="#{msg['body.receiptlog.tab.diangonsis.data.signature.consultant']}" />
				<!-- Consultant -->
				<h:panelGroup>

					<p:selectOneMenu disabled="#{!taskEditable}"
						styleClass="customSerachSelectMenu" style="width:80% !important;"
						panelStyleClass="customSerachSelectMenuPanel"
						value="#{diagnosisViewHandlerAction.signatureTwo}"
						converter="#{diagnosisViewHandlerAction.physiciansToSignListTransformer}"
						filter="true" filterMatchMode="contains">
						<f:selectItem
							itemLabel="#{msg['body.receiptlog.tab.diangonsis.data.signature.consultant.select']}"
							itemValue="#{null}" />

						<f:selectItems
							value="#{diagnosisViewHandlerAction.physiciansToSignList}"
							var="physician" itemLabel="#{physician.person.fullName}"
							itemValue="#{physician}" />

						<p:ajax event="change"
							oncomplete="$('#contentForm\\:submitConsultantChange').click();" />
					</p:selectOneMenu>

					<!-- hidden button for updating on consultant change -->

					<p:commandButton style="display:none" update="@form"
						id="submitConsultantChange">
						<f:actionListener
							binding="#{selectedTask.diagnosisContainer.setPhysicianAsSignatureTwo(diagnosisViewHandlerAction.signatureTwo)}" />
						<f:actionListener
							binding="#{diagnosisViewHandlerAction.onDataChange(selectedTask.diagnosisContainer,'log.patient.task.diagnosisContainer.signature.two',selectedTask.diagnosisContainer.signatureTwo.physician.person.fullName)}" />
					</p:commandButton>

				</h:panelGroup>
				<!-- Consultant role -->
				<h:panelGroup />
				<h:panelGroup>

					<p:selectOneMenu styleClass="customSerachSelectMenu"
						id="consultantToSignRole" editable="true"
						style="width:80% !important" disabled="#{!taskEditable}"
						value="#{selectedTask.diagnosisContainer.signatureTwo.role}">
						<f:selectItems value="#{enumProvider.signatureRoles}"
							var="signatureRole"
							itemLabel="#{msg['enum.signatureRole.'.concat(signatureRole)]}"
							itemValue="#{msg['enum.signatureRole.'.concat(signatureRole)]}" />
						<p:ajax event="change"
							oncomplete="$('#contentForm\\:submitConsultantRoleChange').click();" />
					</p:selectOneMenu>


					<!-- hidden button for updating on consultant role change -->

					<p:commandButton style="display:none" update="@form"
						id="submitConsultantRoleChange">
						<f:actionListener
							binding="#{diagnosisViewHandlerAction.onDataChange(selectedTask.diagnosisContainer,'log.patient.task.diagnosisContainer.signature.two.role',selectedTask.diagnosisContainer.signatureTwo.role)}" />
					</p:commandButton>

				</h:panelGroup>
			</h:panelGrid>
		</h:panelGrid>
	</p:panel>

</ui:composition>

