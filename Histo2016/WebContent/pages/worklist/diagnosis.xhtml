<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:p="http://primefaces.org/ui"
	xmlns:c="http://java.sun.com/jsp/jstl/core">

	<ui:include src="common/navigationBar.xhtml"></ui:include>

	<p:panel style="width:100%;" id="diagnosisView"
		styleClass=" collapsedBorders noPadding noBorders">
		<h:panelGrid columns="1" styleClass="noPadding">
			<h:outputLabel value="Histologisches Gutachten"
				style="font-size:1.5em;"></h:outputLabel>

			<h:panelGrid columns="2" style="margin-top:20px"
				styleClass="noPaddingAll noBordersAll collapsedBordersAll"
				columnClasses="verticalAlignTop,verticalAlignTop">

				<h:panelGrid columns="1" style="width:410px"
					styleClass="noPaddingAll noBordersAll collapsedBordersAll">
					<!-- TODO Update background object, e.g. .blure() (inputtext) -->
					<c:forEach
						items="#{worklistHandlerAction.selectedPatient.selectedTask.samples}"
						var="sample" varStatus="loopCount">
						<h:panelGrid columns="3" id="materialTable"
							columnClasses="firstColumn, secondColumn, thirdColumn"
							styleClass="materialTable noPaddingAll noBordersAll collapsedBordersAll">

							<h:panelGroup>
								<h:outputLabel value="Präparat" style="font-size:1.2em"
									rendered="#{loopCount.index eq 0}"></h:outputLabel>
							</h:panelGroup>

							<h:outputLabel value="#{sample.sampleID}" />

							<p:selectOneMenu value="#{sample.material}"
								styleClass="smallInput" editable="true"
								style="width:200px;float:right;margin-right:30px;">
								<f:selectItem
									itemLabel="#{msg['body.receiptlog.material.select']}"
									itemValue="none" />
								<f:selectItems
									value="#{taskHandlerAction.allAvailableMaterials}" var="list"
									itemLabel="#{list.name}" itemValue="#{list.name}" />
							</p:selectOneMenu>
						</h:panelGrid>
					</c:forEach>

					<h:panelGroup layout="block"
						style="font-size:1.0em;margin-top:10px;">
						<h:outputLabel
							value="Vorgeschichte, klinischer Befund, Fragestellung"></h:outputLabel>
					</h:panelGroup>

					<h:graphicImage value="/resources/gfx/augen.png"
						style="width: 280px;float:right;margin-right:30px;" />

					<h:panelGrid columns="2" columnClasses="verticalAlignTop,"
						style="width:100%"
						styleClass="noPaddingAll noBordersAll collapsedBordersAll">
						<p:selectOneMenu styleClass="smallInput"
							value="#{worklistHandlerAction.selectedPatient.selectedTask.eye}">

							<f:selectItems value="#{enumProvider.eyes}" var="eye"
								itemLabel="#{msg['enum.eye.'.concat(eye)]}" itemValue="#{eye}" />

							<p:ajax event="change" execute="@this"
								listener="#{taskHandlerAction.taskDataChanged(worklistHandlerAction.selectedPatient.selectedTask,'log.patient.task.dataChange.eye',msg['enum.eye.'.concat(worklistHandlerAction.selectedPatient.selectedTask.eye)])}" />
						</p:selectOneMenu>

						<p:inputTextarea rows="2"
							style="width: 270px;float:right;margin-right:30px;"
							value="#{worklistHandlerAction.selectedPatient.selectedTask.caseHistory}" />

					</h:panelGrid>
				</h:panelGrid>


				<h:panelGrid columns="2"
					styleClass="noPaddingAll noBordersAll collapsedBordersAll">
					<!-- date of surgery -->
					<h:outputLabel value="Entnahmedatum"></h:outputLabel>
					<p:calendar pattern="dd.MM.yyyy" mask="true"
						styleClass="taskCalendar"
						value="#{worklistHandlerAction.selectedPatient.selectedTask.dateOfSugeryAsDate}" />

					<!-- date of receipt -->
					<h:outputLabel value="Eingangsdatum"></h:outputLabel>
					<p:calendar pattern="dd.MM.yyyy" mask="true"
						styleClass="taskCalendar"
						value="#{worklistHandlerAction.selectedPatient.selectedTask.dateOfReceiptAsDate}" />

					<!-- Task Number -->
					<h:outputLabel value="Eingangsnummer"></h:outputLabel>
					<p:inputText disabled="true"
						value="#{worklistHandlerAction.selectedPatient.selectedTask.taskID}" />

					<!-- insurance -->
					<h:outputLabel value="Versicherung"></h:outputLabel>

					<p:selectOneButton
						value="#{worklistHandlerAction.selectedPatient.privateInsurance}">
						<f:selectItem itemLabel="regulär" itemValue="#{false}]" />
						<f:selectItem itemLabel="privat" itemValue="#{true}" />
					</p:selectOneButton>


					<!-- ward -->
					<h:outputLabel value="Station"></h:outputLabel>
					<p:selectOneMenu id="wards"
						value="#{worklistHandlerAction.selectedPatient.selectedTask.ward}"
						effect="fold" editable="true">
						<f:selectItems value="#{taskHandlerAction.selectableWards}" />
					</p:selectOneMenu>

					<h:panelGroup layout="block" style="margin: 6px 0px 3px 0px;">
						<h:outputLabel value="Operateur/Einsender" />
					</h:panelGroup>
					<h:panelGroup layout="block" style="margin: 6px 0px 3px 0px;">
						<h:outputLabel
							value="#{worklistHandlerAction.selectedPatient.selectedTask.getPrimaryContact(enumProvider.getContactRole('SURGEON'))}"></h:outputLabel>

						<p:commandLink title="#{msg['body.receiptlog.notification.hint']}"
							style="float: right; margin-right:5px;"
							actionListener="#{contactHandlerAction.prepareContacts(worklistHandlerAction.selectedPatient.selectedTask,contactHandlerAction.personSurgeon,contactHandlerAction.personExtern,contactHandlerAction.personOther,contactHandlerAction.addedContacts)}">
							<i class="fa fa-fw fa-cog" />
							<p:ajax event="dialogReturn" update="navigationForm contentForm" />
						</p:commandLink>
					</h:panelGroup>



					<h:panelGroup layout="block" style="margin: 6px 0px 3px 0px;">
						<h:outputLabel value="Augenarzt"></h:outputLabel>
					</h:panelGroup>

					<h:panelGroup layout="block" style="margin: 6px 0px 3px 0px;">
						<h:outputLabel
							value="#{worklistHandlerAction.selectedPatient.selectedTask.getPrimaryContact(enumProvider.getContactRole('PRIVATE_PHYSICIAN'))}"></h:outputLabel>

						<p:commandLink title="" style="float:right; margin-right:10px;"
							actionListener="#{diagnosisHandlerAction.prepareCopyHistologicalRecord(diagnosis)}"
							update=":contentForm:extendedText">
							<i class="fa fa-hand-o-up"></i>
							<p:ajax event="dialogReturn" update="navigationForm contentForm" />
						</p:commandLink>
					</h:panelGroup>
				</h:panelGrid>
			</h:panelGrid>
			<p:separator />
			<h:outputLabel value="Histlogischer Befund"></h:outputLabel>
			<p:editor id="extendedText"
				value="#{worklistHandlerAction.selectedPatient.selectedTask.histologicalRecord}"
				style="width:100%">
			</p:editor>

			<h:outputLabel value="Diagnose"></h:outputLabel>
			<ui:repeat var="sampel"
				value="#{worklistHandlerAction.selectedPatient.selectedTask.samples}">

				<c:set var="diagnosis" value="#{sampel.getLastRelevantDiagnosis()}" />

				<h:panelGrid columns="4" id="diagnosisTable"
					styleClass="diagnosisTable noPaddingAll noBordersAll collapsedBordersAll"
					columnClasses="firstColumn,secondColumn,thirdColumn,fourthColumn">

					<h:outputLabel value="Probe #{sampel.sampleID}"></h:outputLabel>

					<p:selectOneMenu value="#{diagnosis.diagnosisPrototype}"
						disabled="#{diagnosis.finalized}" styleClass="diagnosisSelectMenu"
						panelStyleClass="diagnosisSelectMenuPanel"
						converter="#{settingsHandlerAction.diagnosisPrototypeListTransformer}"
						filter="true" filterMatchMode="startsWith">
						<f:selectItem
							itemLabel="#{msg['body.receiptlog.tab.diangonsis.data.diangosis.choose']}"
							itemValue="#{null}" />

						<f:selectItems
							value="#{settingsHandlerAction.allAvailableDiagnosisPrototypes}"
							var="diagnosisPrototype" itemLabel="#{diagnosisPrototype.name}"
							itemValue="#{diagnosisPrototype}" />

						<p:ajax event="change"
							listener="#{diagnosis.updateDiagnosisWithPrototype(diagnosis.diagnosisPrototype)}" />
						<p:ajax event="change"
							update="diagnosisTable :contentForm:extendedText"
							listener="#{diagnosisHandlerAction.onDiagnosisPrototypeChanged(diagnosis)}" />
					</p:selectOneMenu>

					<h:inputText value="#{diagnosis.diagnosis}"
						styleClass="diagnosisText"></h:inputText>

					<h:panelGroup>
						<p:commandLink title=""
							rendered="#{diagnosis.diagnosisPrototype ne null}"
							actionListener="#{diagnosisHandlerAction.prepareCopyHistologicalRecord(diagnosis)}"
							update=":contentForm:extendedText">
							<i class="fa fa-hand-o-up"></i>
							<p:ajax event="dialogReturn" update="navigationForm contentForm" />
						</p:commandLink>
					</h:panelGroup>
				</h:panelGrid>
			</ui:repeat>


		</h:panelGrid>
	</p:panel>
</ui:composition>

