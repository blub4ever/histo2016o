<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:p="http://primefaces.org/ui"
	xmlns:c="http://java.sun.com/jsp/jstl/core">

	<ui:include src="common/navigationBar.xhtml"></ui:include>

	<c:set var="selectedTask"
		value="#{worklistHandlerAction.selectedPatient.selectedTask}" />

	<c:set var="taskEditable" scope="session"
		value="#{taskHandlerAction.isTaskEditable(selectedTask)}" />

	<p:panel style="width: 80%"
		styleClass="collapsedBorders noPadding noBorders">

		<h:outputLabel value="#{msg['body.diagnosis.headline']}"
			style="font-size:1.5em;"></h:outputLabel>


		<h:panelGrid columns="3" style="margin-top:10px;"
			styleClass="defaultListingTableTwoLineContainer">

			<!-- Left Column -->
			<h:panelGrid columns="1" styleClass="defaultListingTableContainer">
				<!-- material -->
				<h:panelGrid columns="2" styleClass="defaultListingTableCss"
					columnClasses="defaultListingTableColumnTop,">

					<h:outputLabel value="#{msg['body.diagnosis.material']}" />

					<h:panelGrid columns="1" styleClass="defaultListingTableContainer"
						style="width:410px">
						<c:forEach items="#{selectedTask.samples}" var="sample"
							varStatus="loopCount">

							<h:panelGrid columns="3"
								styleClass="defaultListingTableContainer">

								<h:outputLabel
									value="#{msg['body.diagnosis.diagnosis.sample']} #{sample.sampleID}" />

								<p:inputText value="#{sample.material}"
									disabled="#{!taskEditable}" styleClass="smallInput"
									style="width:200px;float:right;" />
								<p:commandLink
									title="#{msg['body.receiptlog.notification.hint']}"
									rendered="#{taskEditable}"
									style="float: right; margin-right:5px;"
									actionListener="#{taskHandlerAction.prepareSelectMaterialDialog(sample)}">
									<i class="fa fa-fw fa-cog" />
									<p:ajax event="dialogReturn"
										update="navigationForm contentForm" />
								</p:commandLink>
							</h:panelGrid>
						</c:forEach>
					</h:panelGrid>

				</h:panelGrid>
				<!-- material -->

				<!-- historical record -->
				<h:panelGrid columns="1" styleClass="defaultListingTableCssOneCol">
					<h:outputLabel value="#{msg['body.diagnosis.story']}"
						styleClass="big-text" />

					<h:graphicImage value="/resources/gfx/augen.png"
						style="width: 280px;float:right;margin-right:50px;" />
				</h:panelGrid>
				<!-- historical record -->

				<!-- Eye -->
				<h:panelGrid columns="2" styleClass="defaultListingTableCssOneCol">
					<p:selectOneMenu styleClass="smallInput"
						disabled="#{!taskEditable}" value="#{selectedTask.eye}">

						<f:selectItems value="#{enumProvider.eyes}" var="eye"
							itemLabel="#{msg['enum.eye.'.concat(eye)]}" itemValue="#{eye}" />

						<p:ajax event="change" execute="@this"
							listener="#{mainHandlerAction.saveDataChange(selectedTask,'log.patient.task.change.eye',selectedTask.eye)}" />
					</p:selectOneMenu>

					<p:selectOneMenu id="historyText" style="width: 80%"
						disabled="#{!taskEditable}" value="#{selectedTask.caseHistory}"
						editable="true">
						<f:selectItem itemLabel="Select One"
							itemValue="#{msg['body.diagnosis.story.watermark']}" />
						<f:selectItems value="#{taskHandlerAction.caseHistoryList}"
							var="item" itemLabel="#{item.value}" itemValue="#{item.value}" />

						<p:ajax event="change" execute="@this"
							listener="#{mainHandlerAction.saveDataChange(selectedTask,'log.patient.task.change.caseHistory',selectedTask.caseHistory)}" />
					</p:selectOneMenu>
				</h:panelGrid>
				<!-- Eye -->
			</h:panelGrid>
			<!-- Left Column -->

			<h:panelGroup />

			<!-- Right Column -->
			<h:panelGrid columns="1" styleClass="defaultListingTableContainer">
				<h:panelGrid columns="2" styleClass="defaultListingTableCss">
					<!-- date of surgery -->
					<h:outputLabel value="#{msg['body.diagnosis.surgeryDate']}" />
					<p:calendar pattern="dd.MM.yyyy" mask="true"
						disabled="#{!taskEditable}"
						value="#{selectedTask.dateOfSugeryAsDate}">
						<p:ajax event="dateSelect"
							listener="#{mainHandlerAction.saveDataChange(selectedTask,'log.patient.task.change.dateOfSurgery',mainHandlerAction.date(selectedTask.dateOfSugeryAsDate))}" />
						<f:ajax event="change" execute="@this"
							listener="#{mainHandlerAction.saveDataChange(selectedTask,'log.patient.task.change.dateOfSurgery',mainHandlerAction.date(selectedTask.dateOfSugeryAsDate))}" />
					</p:calendar>

					<!-- date of receipt -->
					<h:outputLabel value="#{msg['body.diagnosis.taskEDate']}" />
					<p:calendar pattern="dd.MM.yyyy" mask="true"
						disabled="#{!taskEditable}"
						value="#{selectedTask.dateOfReceiptAsDate}">
						<p:ajax event="dateSelect"
							listener="#{mainHandlerAction.saveDataChange(selectedTask,'log.patient.task.change.receiptDate',mainHandlerAction.date(selectedTask.dateOfReceiptAsDate))}" />
						<f:ajax event="change" execute="@this"
							listener="#{mainHandlerAction.saveDataChange(selectedTask,'log.patient.task.change.receiptDate',mainHandlerAction.date(selectedTask.dateOfReceiptAsDate))}" />
					</p:calendar>

					<!-- Task Number -->
					<h:outputLabel value="#{msg['body.diagnosis.taskNumber']}" />
					<p:inputText disabled="true" value="#{selectedTask.taskID}" />

					<!-- insurance -->
					<h:outputLabel value="#{msg['body.diagnosis.insurance']}" />

					<p:selectOneButton disabled="#{!taskEditable}"
						value="#{worklistHandlerAction.selectedPatient.privateInsurance}">
						<f:selectItem
							itemLabel="#{msg['body.diagnosis.insurance.private']}"
							itemValue="#{false}]" />
						<f:selectItem
							itemLabel="#{msg['body.diagnosis.insurance.normal']}"
							itemValue="#{true}" />
						<p:ajax event="change" execute="@this"
							listener="#{mainHandlerAction.saveDataChange(selectedTask,'log.patient.task.change.insurance', worklistHandlerAction.selectedPatient.privateInsurance)}" />
					</p:selectOneButton>

					<!-- ward -->
					<h:outputLabel value="#{msg['body.diagnosis.ward']}" />
					<p:selectOneMenu id="wards" value="#{selectedTask.ward}"
						editable="true" disabled="#{!taskEditable}">
						<f:selectItems value="#{taskHandlerAction.wardList}"
							itemValue="#{ward.value}" itemLabel="#{ward.value}" var="ward" />
						<p:ajax event="change" execute="@this"
							listener="#{mainHandlerAction.saveDataChange(selectedTask,'log.patient.task.change.ward', selectedTask.ward)}" />
					</p:selectOneMenu>

					<!-- surgeon -->
					<h:panelGroup layout="block" style="margin: 6px 0px 3px 0px;">
						<h:outputLabel value="#{msg['body.diagnosis.surgeon']}" />
					</h:panelGroup>

					<h:panelGroup layout="block" style="margin: 6px 0px 3px 0px;">
						<h:outputLabel style="margin-left:10px;"
							value="#{selectedTask.getPrimaryContact('SURGEON')}"></h:outputLabel>

						<!-- quickContact surgeon -->
						<p:commandLink style="float: right; margin-right:5px;"
							styleClass="noUnderlineAtLink"
							title="#{msg['body.receiptlog.notification.surgeon.hint']}"
							actionListener="#{contactHandlerAction.prepareQuickContactsDialog(worklistHandlerAction.selectedPatient.selectedTask,'SURGEON')}"
							disabled="#{!taskEditable}">
							<i class="fa fa-fw fa-scissors" />
							<p:ajax event="dialogReturn" update="navigationForm contentForm" />
						</p:commandLink>
					</h:panelGroup>

					<h:panelGroup layout="block" style="margin: 6px 0px 3px 0px;">
						<h:outputLabel value="#{msg['body.diagnosis.privatePhysician']}"></h:outputLabel>
					</h:panelGroup>

					<h:panelGroup layout="block" style="margin: 6px 0px 3px 0px;">
						<h:outputLabel style="margin-left:10px;"
							value="#{selectedTask.getPrimaryContact('PRIVATE_PHYSICIAN')}"></h:outputLabel>

						<!-- quickcontact private physician  -->
						<p:commandLink style="float: right; margin-right:5px;"
							styleClass="noUnderlineAtLink"
							title="#{msg['body.receiptlog.notification.ophthalmologist.hint']}"
							actionListener="#{contactHandlerAction.prepareQuickContactsDialog(worklistHandlerAction.selectedPatient.selectedTask,'PRIVATE_PHYSICIAN')}"
							disabled="#{!taskEditable}">
							<i class="fa fa-fw fa-eye" />
							<p:ajax event="dialogReturn" update="navigationForm contentForm" />
						</p:commandLink>
					</h:panelGroup>

				</h:panelGrid>
			</h:panelGrid>
			<!-- Right Column -->

		</h:panelGrid>

		<p:separator />

		<!-- Diagnoses -->
		<ui:repeat var="revision"
			value="#{selectedTask.diagnosisContainer.diagnosisRevisions}">

			<h:panelGrid columns="2" styleClass="defaultListingTableCss"
				columnClasses="defaultListingTableColumnTop,">
				<!-- Extended Diagnosis Text -->
				<h:outputLabel value="#{revision.name}"></h:outputLabel>
				<h:panelGroup id="extendedTextParent">
					<p:inputTextarea style="width:100%" id="extendedText" rows="15"
						disabled="#{!taskEditable}" value="#{revision.text}">

						<p:ajax event="change" execute="@this"
							listener="#{mainHandlerAction.saveDataChange(selectedTask,'log.patient.task.change.histologicalRecord', revision.text)}" />
					</p:inputTextarea>


					<p:commandButton style="display:none" id="submitDiagnosisChange"
						name="submitDiagnosisChange" process="extendedTextParent"></p:commandButton>
				</h:panelGroup>

				<!-- Diagnosis for sample -->
				<h:outputLabel value="#{msg['body.diagnosis.diagnoses']}"></h:outputLabel>
				<ui:repeat var="diagnosis" value="#{revision.diagnoses}">
					<h:panelGrid columns="3" styleClass="defaultListingTableContainer"
						columnClasses="defaultListingTableColumn15,">
						<!-- sample -->
						<h:outputLabel
							value="#{msg['body.diagnosis.diagnosis.sample']} #{diagnosis.sample.sampleID}"></h:outputLabel>

						<h:panelGrid columns="2" styleClass="defaultListingTableContainer">
							<!-- diagnosis category -->
							<p:selectOneMenu value="#{diagnosis.diagnosisPrototype}"
								styleClass="customSerachSelectMenu" disabled="#{!taskEditable}"
								panelStyleClass="customSerachSelectMenuPanel"
								converter="#{settingsHandlerAction.diagnosisPrototypeListTransformer}"
								filter="true" filterMatchMode="startsWith">
								<f:selectItem
									itemLabel="#{msg['body.receiptlog.tab.diangonsis.data.diangosis.choose']}"
									itemValue="#{null}" />

								<f:selectItems
									value="#{settingsHandlerAction.allAvailableDiagnosisPrototypes}"
									var="diagnosisPrototype"
									itemLabel="#{diagnosisPrototype.diagnosis}"
									itemValue="#{diagnosisPrototype}" />

								<p:ajax event="change" update="contentForm"
									listener="#{diagnosisHandlerAction.onDiagnosisPrototypeChanged(diagnosis)}" />

							</p:selectOneMenu>

							<!-- copy diagnosis text -->
							<p:commandLink styleClass="noUnderlineAtLink"
								style="margin-left:20px;" disabled="#{!taskEditable}"
								title="#{msg['body.diagnosis.diagnosis.histologicalRecordPreset']}"
								rendered="#{diagnosis.diagnosisPrototype ne null}"
								actionListener="#{diagnosisHandlerAction.prepareCopyHistologicalRecordDialog(diagnosis)}"
								update="contentForm">
								<i class="fa fa-hand-o-up"></i>
								<p:ajax event="dialogReturn" update="navigationForm contentForm" />
							</p:commandLink>
						</h:panelGrid>

						<!-- malign -->
						<h:panelGrid columns="2" style="float:right;margin-right:20px;"
							styleClass="verticalAlignMiddleAll">
							<h:outputLabel
								value="#{msg['body.receiptlog.tab.diangonsis.data.diangosis.malign']}" />
							<p:selectBooleanCheckbox value="#{diagnosis.malign}"
								disabled="#{!taskEditable}" style="margin:3px 0px 0px 3px;">

								<f:ajax event="change"
									listener="#{mainHandlerAction.saveDataChange(diagnosis,'log.patient.task.sample.diagnosis.changed.malign',diagnosis.malign)}" />
							</p:selectBooleanCheckbox>
						</h:panelGrid>
					</h:panelGrid>

					<h:panelGrid columns="2" styleClass="defaultListingTableContainer"
						style="width:100%" columnClasses="defaultListingTableColumn15,">
						<h:outputLabel />
						<!-- diagnosis text -->
						<p:inputTextarea value="#{diagnosis.diagnosis}" id="diagnosisText"
							disabled="#{!taskEditable}" style="width:100%">
							<p:watermark for="diagnosisText"
								value="#{msg['body.receiptlog.tab.diangonsis.data.diangosis.watermark']}" />
							<f:ajax event="change" execute="@this"
								listener="#{mainHandlerAction.saveDataChange(diagnosis,'log.patient.task.sample.diagnosis.changed.diagnosis.text',diagnosis.diagnosis)}" />
						</p:inputTextarea>
					</h:panelGrid>
					<!-- Diagnosis for sample -->
				</ui:repeat>
			</h:panelGrid>
		</ui:repeat>

		<p:separator />

		<h:panelGrid columns="3"
			styleClass="defaultListingTableTwoLineContainer">
			<!-- left column -->
			<h:panelGrid columns="2" styleClass="defaultListingTableCss">
				<!-- Date of signature -->
				<h:outputLabel
					value="#{msg['body.receiptlog.tab.diangonsis.data.signature.date']}"></h:outputLabel>
				<p:calendar pattern="dd.MM.yyyy" mask="true"
					disabled="#{!taskEditable}"
					value="#{selectedTask.diagnosisContainer.signatureDateAsDate}">
					<p:ajax event="dateSelect"
						listener="#{mainHandlerAction.saveDataChange(selectedTask.diagnosisContainer,'log.patient.task.diagnosisContainer.signautre.date',mainHandlerAction.date(selectedTask.diagnosisContainer.signatureDate))}" />
					<f:ajax event="change" execute="@this"
						listener="#{mainHandlerAction.saveDataChange(selectedTask.diagnosisContainer,'log.patient.task.diagnosisContainer.signautre.date',mainHandlerAction.date(selectedTask.diagnosisContainer.signatureDate))}" />
				</p:calendar>
			</h:panelGrid>

			<h:panelGroup />

			<!-- right column -->
			<h:panelGrid columns="2" styleClass="defaultListingTableCss">

				<!-- physician -->
				<h:outputLabel
					value="#{msg['body.receiptlog.tab.diangonsis.data.signature.physician']}" />
				<h:panelGroup>
					<p:selectOneMenu disabled="#{!taskEditable}"
						styleClass="customSerachSelectMenu" style="width:80% !important;"
						panelStyleClass="customSerachSelectMenuPanel"
						value="#{taskHandlerAction.signatureOne}"
						converter="#{taskHandlerAction.physiciansToSignListTransformer}"
						filter="true" filterMatchMode="contains">

						<f:selectItem
							itemLabel="#{msg['body.receiptlog.tab.diangonsis.data.signature.physician.select']}"
							itemValue="#{null}" />

						<f:selectItems value="#{taskHandlerAction.physiciansToSignList}"
							var="physician" itemLabel="#{physician.person.fullName}"
							itemValue="#{physician}" />

						<p:ajax event="change"
							onstart="$('#contentForm\\:submitPhysicianChange').click();" />

					</p:selectOneMenu>

					<p:commandButton style="display:none" update="@form"
						id="submitPhysicianChange">
						<f:actionListener
							binding="#{selectedTask.diagnosisContainer.setPhysicianAsSignatureOne(taskHandlerAction.signatureOne)}" />
						<f:actionListener
							binding="#{mainHandlerAction.saveDataChange(selectedTask.diagnosisContainer,'log.patient.task.diagnosisContainer.signature.one',selectedTask.diagnosisContainer.signatureOne.physician.person.fullName)}" />
					</p:commandButton>
				</h:panelGroup>


				<h:panelGroup />

				<!-- physician role -->
				<h:panelGroup>
					<p:selectOneMenu styleClass="customSerachSelectMenu"
						id="pysicianToSignRole" editable="true"
						style="width:80% !important;" disabled="#{!taskEditable}"
						value="#{selectedTask.diagnosisContainer.signatureOne.role}">
						<f:selectItems value="#{enumProvider.signatureRoles}"
							var="signatureRole"
							itemLabel="#{msg['enum.signatureRole.'.concat(signatureRole)]}"
							itemValue="#{msg['enum.signatureRole.'.concat(signatureRole)]}" />
						<p:ajax event="change"
							onstart="$('#contentForm\\:submitPhysicianRoleChange').click();" />
					</p:selectOneMenu>

					<!-- hidden button for updating on physician role change -->

					<p:commandButton style="display:none" update="@form"
						id="submitPhysicianRoleChange">
						<f:actionListener
							binding="#{mainHandlerAction.saveDataChange(selectedTask.diagnosisContainer,'log.patient.task.diagnosisContainer.signature.one.role',selectedTask.diagnosisContainer.signatureOne.role)}" />
					</p:commandButton>
				</h:panelGroup>


				<h:outputLabel
					value="#{msg['body.receiptlog.tab.diangonsis.data.signature.consultant']}" />
				<!-- Consultant -->
				<h:panelGroup>

					<p:selectOneMenu disabled="#{!taskEditable}"
						styleClass="customSerachSelectMenu" style="width:80% !important;"
						panelStyleClass="customSerachSelectMenuPanel"
						value="#{taskHandlerAction.signatureTwo}"
						converter="#{taskHandlerAction.physiciansToSignListTransformer}"
						filter="true" filterMatchMode="contains">
						<f:selectItem
							itemLabel="#{msg['body.receiptlog.tab.diangonsis.data.signature.consultant.select']}"
							itemValue="#{null}" />

						<f:selectItems value="#{taskHandlerAction.physiciansToSignList}"
							var="physician" itemLabel="#{physician.person.fullName}"
							itemValue="#{physician}" />

						<p:ajax event="change"
							oncomplete="$('#contentForm\\:submitConsultantChange').click();" />
					</p:selectOneMenu>

					<!-- hidden button for updating on consultant change -->

					<p:commandButton style="display:none" update="@form"
						id="submitConsultantChange">
						<f:actionListener
							binding="#{selectedTask.diagnosisContainer.setPhysicianAsSignatureTwo(taskHandlerAction.signatureTwo)}" />
						<f:actionListener
							binding="#{mainHandlerAction.saveDataChange(selectedTask.diagnosisContainer,'log.patient.task.diagnosisContainer.signature.two',selectedTask.diagnosisContainer.signatureTwo.physician.person.fullName)}" />
					</p:commandButton>

				</h:panelGroup>
				<!-- Consultant role -->
				<h:panelGroup />
				<h:panelGroup>

					<p:selectOneMenu styleClass="customSerachSelectMenu"
						id="consultantToSignRole" editable="true"
						style="width:80% !important"
						disabled="#{selectedTask.diagnosisContainer.signatureTwo.physician eq null}"
						value="#{selectedTask.diagnosisContainer.signatureTwo.role}">
						<f:selectItems value="#{enumProvider.signatureRoles}"
							var="signatureRole"
							itemLabel="#{msg['enum.signatureRole.'.concat(signatureRole)]}"
							itemValue="#{msg['enum.signatureRole.'.concat(signatureRole)]}" />
						<p:ajax event="change"
							oncomplete="$('#contentForm\\:submitConsultantRoleChange').click();" />
					</p:selectOneMenu>


					<!-- hidden button for updating on consultant role change -->

					<p:commandButton style="display:none" update="@form"
						id="submitConsultantRoleChange">
						<f:actionListener
							binding="#{mainHandlerAction.saveDataChange(selectedTask.diagnosisContainer,'log.patient.task.diagnosisContainer.signature.two.role',selectedTask.diagnosisContainer.signatureTwo.role)}" />
					</p:commandButton>

				</h:panelGroup>
			</h:panelGrid>
		</h:panelGrid>
	</p:panel>

</ui:composition>

