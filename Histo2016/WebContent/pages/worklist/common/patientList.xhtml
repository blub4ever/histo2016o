<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:p="http://primefaces.org/ui"
	xmlns:c="http://java.sun.com/jsp/jstl/core">


	<p:poll interval="10" update=":navigationForm" stop="#{!worklistViewHandlerAction.worklist.autoUpdate}"
		listener="#{worklistViewHandlerAction.updateCurrentWorklist()}" />

	<!-- Search -->
	<h:panelGroup styleClass="searchContainer" layout="block">
		<p:focus for="searchField" />
		<p:inputText placeholder="#{msg.headSearch}" id="searchField"
			styleClass="seachFiled" value="#{searchHandlerAction.searchString}"
			onkeyup="autoSumbitQuickSeach(event);"
			onkeypress="if(submitQuickSearch(event)){ return false;}">
		</p:inputText>

		<script type="text/javascript">
			function submitQuickSearch(event) {
				
				if (event.keyCode == 13 || event.keyCode == 10) {
					if (event.keyCode == 10 || event.ctrlKey) {
						$('#navigationForm\\:submitQuickSearchBtnAlternate').click();
					} else {
						$('#navigationForm\\:submitQuickSearchBtn').click();

					}
					return true;
				}

				return false;
			}

			function autoSumbitQuickSeach(event) {
				if (event.keyCode != 13 &amp;&amp; event.keyCode != 10) {
					
					var strg = $('#navigationForm\\:searchField').val();
		
					var found = strg.match(/^\d{8}$/g);
					if(found != null){
						//TODO
						
					}
						
				}
			}
		</script>

		<p:commandButton id="submitQuickSearchBtn"
			actionListener="#{searchHandlerAction.quickSearch(false)}"
			style="display:none" update="navigationForm contentForm headerForm">
			<p:ajax event="dialogReturn"
				update="navigationForm contentForm :headerForm" />
		</p:commandButton>

		<p:commandButton id="submitQuickSearchBtnAlternate"
			actionListener="#{searchHandlerAction.quickSearch(true)}"
			style="display:none" update="navigationForm contentForm headerForm">
			<p:ajax event="dialogReturn"
				update="navigationForm contentForm headerForm" />
		</p:commandButton>

	</h:panelGroup>

	<!-- Nav Table -->
	<p:dataTable var="patient" id="patientList"
		value="#{worklistViewHandlerAction.worklist.items}"
		selectionMode="single"
		selection="#{commonDataHandlerAction.selectedPatient}"
		rowKey="#{patient.id}" styleClass="navigationDataTable">

		<p:ajax event="rowSelect"
			update=":contentForm :headerForm :navigationForm"
			listener="#{worklistViewHandlerAction.onSelectPatient(commonDataHandlerAction.selectedPatient)}" />

		<p:column>
			<!-- Header -->
			<f:facet name="header">
				<h:panelGroup layout="block">
					<h:outputLabel value="#{msg['body.worklist.navigation.headline']}"
						style="float:left;"></h:outputLabel>
					<h:panelGroup style="float: right">
						<!-- Button UP -->
						<p:commandLink
							title="#{msg['body.worklist.navigation.button.up']}"
							actionListener="#{worklistViewHandlerAction.selectNextTask()}"
							update="navigationForm contentForm">
							<i class="fa fa-arrow-circle-up"></i>
						</p:commandLink>

						<!-- Button Down -->
						<p:commandLink
							title="#{msg['body.worklist.navigation.button.down']}"
							actionListener="#{worklistViewHandlerAction.selectPreviouseTask()}"
							update="navigationForm contentForm">
							<i class="fa fa-arrow-circle-down"></i>
						</p:commandLink>

						<!-- Button Sort -->
						<p:commandLink
							title="#{msg['body.worklist.navigation.button.sort']}"
							actionListener="#{worklistSettingsDialog.initAndPrepareBeanForSorting()}">
							<i class="fa fa-th-list"></i>
							<p:ajax event="dialogReturn" update="navigationForm contentForm" />
						</p:commandLink>

						<!-- Worklist settings -->
						<p:commandLink
							title="#{msg['body.worklist.navigation.button.settings']}"
							actionListener="#{worklistSettingsDialog.initAndPrepareBeanForSettings()}">
							<i class="fa fa-wrench"></i>
							<p:ajax event="dialogReturn" update="navigationForm contentForm" />
						</p:commandLink>

						<!-- Worklist change -->
						<p:commandLink
							title="#{msg['body.worklist.navigation.button.changelist']}"
							actionListener="#{worklistSearchDialogHandler.initAndPrepareBean()}">
							<i class="fa fa-search"></i>
							<p:ajax event="dialogReturn" update="navigationForm contentForm" />
						</p:commandLink>
					</h:panelGroup>
				</h:panelGroup>
			</f:facet>

			<!-- Data -->
			<p:panelGrid styleClass="contentTable noBordersAll">

				<p:row>
					<p:column>
						<h:outputText
							value="#{patient.person.name}, #{patient.person.surname}" />
					</p:column>
					<p:column>
						<h:outputText
							value="PIZ: #{patient.piz ne 0 ? patient.piz : 'none'}" />
					</p:column>
				</p:row>
				<p:row>
					<p:column>
						<h:outputLabel
							value="#{mainHandlerAction.date(patient.person.birthday)}"
							rendered="#{patient.person.birthday ne null}" />
					</p:column>
					<p:column>
					</p:column>
				</p:row>

				<!-- Active Tasks -->
				<p:row>
					<p:column style="vertical-align: top !important;">
						<h:outputLabel
							value="#{msg['body.worklist.navigation.activtasks']}" />
					</p:column>
					<p:column>
						<!-- no tasks -->
						<h:outputLabel
							rendered="#{!patient.hasActiveTasks(worklistViewHandlerAction.worklist.showActiveTasksExplicit)}"
							value="#{msg['body.worklist.navigation.activtasks.none']}"></h:outputLabel>

						<!-- task list -->
						<p:repeat var="task"
							value="#{patient.getActiveTasks(worklistViewHandlerAction.worklist.showActiveTasksExplicit)}">
							<p:commandLink
								actionListener="#{worklistViewHandlerAction.onSelectTaskAndPatient(task)}"
								update="navigationForm contentForm headerForm"
								styleClass="noUnderlineAtLink">

								<h:outputLabel value="#{task.taskID}"
									style="#{commonDataHandlerAction.selectedTask eq task ? 'text-decoration: underline;' : ''}" />

								<!-- priority -->
								<h:panelGroup rendered="#{task.taskPriority ne 'NONE'}">
									<i style="margin-left: 5px;"
										class="fa fa-exclamation #{task.taskPriority eq 'HIGH' ? 'icon-orange' : 'icon-red'}"
										title="#{msg['body.worklist.navigation.activtasks.new']}" />
								</h:panelGroup>

								<!-- staining needed -->
								<h:panelGroup>

									<ui:fragment rendered="#{task.active}">
										<i style="margin-left: 5px;" class="fa fa-ship icon-purple" />
									</ui:fragment>


									<!-- staining needed = green -->
									<ui:fragment
										rendered="#{task.isListedInFavouriteList('StainingList')}">
										<i style="margin-left: 5px;" class="fa fa-image icon-green"
											title="#{msg['body.worklist.navigation.activtasks.staining']}" />
									</ui:fragment>

									<!-- re-staining needed = orange -->
									<ui:fragment
										rendered="#{task.isListedInFavouriteList('ReStainingList')}">
										<i style="margin-left: 5px;" class="fa fa-image icon-orange"
											title="#{msg['body.worklist.navigation.activtasks.restaining']}" />
									</ui:fragment>

									<!--  no staining needed = purple -->
									<ui:fragment
										rendered="#{task.isListedInFavouriteList('StayInStainingList')}">
										<i style="margin-left: 5px;" class="fa fa-image icon-purple"
											title="#{msg['body.worklist.navigation.activtasks.stainingPhase']}" />
									</ui:fragment>


									<!-- diagnosis needed -->
									<!-- diagnosis needed = green -->
									<ui:fragment
										rendered="#{task.isListedInFavouriteList('DiagnosisList')}">
										<i style="margin-left: 5px;" class="fa fa-eye icon-green"
											title="#{msg['body.worklist.navigation.activtasks.diagnosis']}" />
									</ui:fragment>

									<!-- re-diagnosis needed = orange -->
									<ui:fragment
										rendered="#{task.isListedInFavouriteList('ReDiagnosisList')}">
										<i style="margin-left: 5px;" class="fa fa-eye icon-orange"
											title="#{msg['body.worklist.navigation.activtasks.rediagnosis'] }" />
									</ui:fragment>

									<!-- no diagnosis needed = purple -->
									<ui:fragment
										rendered="#{task.isListedInFavouriteList('StayInDiagnosisList')}">
										<i style="margin-left: 5px;" class="fa fa-eye icon-purple"
											title="#{msg['body.worklist.navigation.activtasks.diagnosisPhase'] }" />
									</ui:fragment>

									<!-- notification needed -->
									<!-- notification need = green -->
									<ui:fragment
										rendered="#{task.isListedInFavouriteList('NotificationList')}">
										<i style="margin-left: 5px;"
											class="fa fa-volume-up icon-green"
											title="#{msg['body.worklist.navigation.activtasks.diagnosis']}" />
									</ui:fragment>

									<!-- stay in phase = purple -->
									<ui:fragment
										rendered="#{task.isListedInFavouriteList('StayInNotificationList')}">
										<i style="margin-left: 5px;"
											class="fa fa-volume-up icon-purple"
											title="#{msg['body.worklist.navigation.activtasks.rediagnosis'] }" />
									</ui:fragment>
								</h:panelGroup>

								<!-- Pendings completed -->
								<h:panelGroup rendered="#{task.finalized}">
									<i style="margin-left: 5px;"
										class="fa fa-check-circle icon-green"
										title="#{msg['body.worklist.navigation.activtasks.pendencies']}" />
								</h:panelGroup>

							</p:commandLink>
							<br />
						</p:repeat>

					</p:column>
				</p:row>

				<!-- Non active Tasks -->
				<p:row
					rendered="#{patient.hasNoneActiveTasks() and worklistViewHandlerAction.worklist.showNoneActiveTasks}">
					<p:column style="vertical-align: top !important;">
						<h:outputLabel value="#{msg['body.worklist.navigation.tasks']}" />
					</p:column>
					<p:column>
						<!-- task list -->
						<p:repeat var="task" value="#{patient.getNoneActiveTasks()}">
							<p:commandLink
								actionListener="#{worklistViewHandlerAction.onSelectTaskAndPatient(task)}"
								update="navigationForm contentForm headerForm"
								styleClass="noUnderlineAtLink">
								<h:outputLabel value="#{task.taskID}"
									style="#{commonDataHandlerAction.selectedTask eq task ? 'text-decoration: underline;' : ''}" />
							</p:commandLink>
							<br />
						</p:repeat>

					</p:column>
				</p:row>
			</p:panelGrid>
		</p:column>

	</p:dataTable>

	<p:contextMenu for="patientList">
		<p:menuitem value="Entfernen" icon="ui-icon-close"
			actionListener="#{worklistViewHandlerAction.removeFromWorklist(commonDataHandlerAction.selectedPatient)}"
			update="navigationForm contentForm" />
	</p:contextMenu>
</ui:composition>
