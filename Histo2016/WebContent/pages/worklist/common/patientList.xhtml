<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:p="http://primefaces.org/ui"
	xmlns:c="http://java.sun.com/jsp/jstl/core">

	<p:poll interval="#{worklistViewHandlerAction.worklist.udpateInterval}"
		update=":navigationForm:patientList"
		rendered="#{worklistViewHandlerAction.worklist.autoUpdate}"
		stop="#{!worklistViewHandlerAction.worklist.autoUpdate}"
		listener="#{worklistViewHandlerAction.updateCurrentWorklist()}" />

	<!-- Search -->
	<h:panelGrid columns="2"
		styleClass="searchContainer defaultListingTableContainer">

		<h:panelGroup>

			<p:focus for="searchField" />

			<p:inputText placeholder="#{msg.headSearch}" id="searchField"
				styleClass="seachFiled" value="#{globalEditViewHandler.quickSearch}"
				onkeyup="autoSumbitQuickSeach(event);"
				onkeypress="if(submitQuickSearch(event)){ return false;}">
			</p:inputText>

			<script type="text/javascript">
			function submitQuickSearch(event) {
				
				if (event.keyCode == 13 || event.keyCode == 10) {
						$('#navigationForm\\:submitQuickSearchBtn').click();
					return true;
				}

				return false;
			}

			function autoSumbitQuickSeach(event) {
				if (event.keyCode != 13 &amp;&amp; event.keyCode != 10) {
					
					var strg = $('#navigationForm\\:searchField').val();
		
					var found = strg.match(/^\d{8}$/g);
					if(found != null){
						// TODO						
					}
						
				}
			}
		</script>
		</h:panelGroup>

		<p:commandButton id="submitQuickSearchBtn"
			actionListener="#{globalEditViewHandler.quickSearch()}"
			update="navigationForm:patientList contentForm headerForm"
			icon="fa fa-mail-forward">
			<p:ajax event="dialogReturn"
				update="navigationForm:patientList contentForm :headerForm" />
		</p:commandButton>

	</h:panelGrid>

	<h:panelGrid columns="2" styleClass="patientNavigationHeader">
		<h:outputLabel value="#{msg['body.worklist.navigation.headline']}" />

		<h:panelGroup styleClass="buttonContainer">
			<!-- Button UP -->
			<p:commandLink title="#{msg['body.worklist.navigation.button.up']}"
				actionListener="#{worklistViewHandlerAction.selectNextTask()}"
				update="navigationForm:patientList contentForm headerForm">
				<i class="fa fa-arrow-circle-up"></i>
			</p:commandLink>

			<!-- Button Down -->
			<p:commandLink title="#{msg['body.worklist.navigation.button.down']}"
				actionListener="#{worklistViewHandlerAction.selectPreviouseTask()}"
				update="navigationForm:patientList contentForm headerForm">
				<i class="fa fa-arrow-circle-down"></i>
			</p:commandLink>

			<!-- Button Sort -->
			<p:commandLink title="#{msg['body.worklist.navigation.button.sort']}"
				actionListener="#{worklistSettingsDialog.initAndPrepareBeanForSorting()}">
				<i class="fa fa-th-list"></i>
				<p:ajax event="dialogReturn"
					update="navigationForm contentForm headerForm" />
			</p:commandLink>

			<!-- Worklist settings -->
			<p:commandLink
				title="#{msg['body.worklist.navigation.button.settings']}"
				actionListener="#{worklistSettingsDialog.initAndPrepareBeanForSettings()}">
				<i class="fa fa-wrench"></i>
				<p:ajax event="dialogReturn"
					update="navigationForm contentForm headerForm" />
			</p:commandLink>

			<!-- Worklist change -->
			<p:commandLink partialSubmit="true" process="@this" rendered="userHandlerAction.currentUserHasPermission('WORKLIST')}"
				title="#{msg['body.worklist.navigation.button.changelist']}"
				actionListener="#{dialogHandlerAction.worklistSearchDialog.initAndPrepareBean()}">
				<i class="fa fa-search"></i>
				<p:ajax event="dialogReturn"
					update="navigationForm contentForm headerForm" />
			</p:commandLink>
			
			<!-- Worklist clear -->
			<p:commandLink partialSubmit="true" process="@this"
				title="#{msg['body.worklist.navigation.button.changelist']}"
				actionListener="#{worklistViewHandlerAction.clearWorklist(worklistViewHandlerAction.worklist)}"
				update="navigationForm contentForm headerForm">
				<i class="fa fa-times-circle-o"></i>
			</p:commandLink>
		</h:panelGroup>

	</h:panelGrid>

	<!-- Nav Table -->
	<p:scrollPanel styleClass="patientNavigationScroll"
		id="patientNavigationScroll">

		<p:dataTable var="patient" id="patientList"
			value="#{worklistViewHandlerAction.worklist.items}"
			selectionMode="single" rowIndexVar="rowIdx"
			selection="#{globalEditViewHandler.selectedPatient}"
			rowKey="#{patient.id}" styleClass="patientNavigationTable">

			<p:ajax event="rowSelect"
				update=":navigationForm:patientList :contentForm :headerForm"
				listener="#{worklistViewHandlerAction.onSelectPatient(globalEditViewHandler.selectedPatient)}" />

			<p:column>
				<!-- Header -->
				<h:panelGrid styleClass="newStyleListingTable" columns="2"
					columnClasses="columnLabelContainer150,">

					<h:outputLabel
						value="#{patient.person.lastName}, #{patient.person.firstName}" />
					<h:outputLabel
						value="PIZ: #{patient.piz ne 0 ? patient.piz : 'none'}" />

					<h:outputLabel value="#{patient.person.birthday}"
						rendered="#{patient.person.birthday ne null}">
						<f:convertDateTime type="date" pattern="dd.MM.yyyy" />
					</h:outputLabel>
					<h:outputLabel rendered="#{patient.person.birthday eq null}"
						value="" />
					<h:outputLabel value="" />
				</h:panelGrid>

				<!-- tasks -->
				<h:panelGrid styleClass="newStyleListingTable" columns="2"
					columnClasses="columnTop columnLabelContainer150,">
					<h:outputLabel
						value="#{msg['body.worklist.navigation.activtasks']}"
						style="font-size: 1.2em !important" />
					<!-- task list -->
					<p:repeat var="task"
						value="#{patient.getActiveTasks(worklistViewHandlerAction.worklist.showActiveTasksExplicit)}">
						<p:commandLink partialSubmit="true" process="@this"
							actionListener="#{worklistViewHandlerAction.onSelectTaskAndPatient(task)}"
							update="headerForm contentForm navigationForm:patientList"
							styleClass="noUnderlineAtLink">

							<h:outputLabel value="#{task.taskID}"
								style="#{globalEditViewHandler.selectedTask eq task ? 'text-decoration: underline;font-weight:bold' : ''};font-size: 1.2em !important" />

							<!-- priority -->
							<h:panelGroup rendered="#{task.taskPriority ne 'NONE'}">
								<i style="margin-left: 5px;"
									class="fa fa-exclamation #{task.taskPriority eq 'HIGH' ? 'icon-orange' : 'icon-red'}"
									title="#{msg['body.worklist.navigation.activtasks.new']}" />
							</h:panelGroup>

							<!-- staining needed -->
							<h:panelGroup>
								<!--  
									<ui:fragment rendered="#{task.active}">
										<i style="margin-left: 5px;" class="fa fa-ship icon-purple" />
									</ui:fragment>-->

								<!-- staining needed = green -->
								<ui:fragment rendered="#{task.taskStatus.stainingNeeded}">
									<i style="margin-left: 5px;" class="fa fa-image icon-green"
										title="#{msg['body.worklist.navigation.activtasks.staining']}" />
								</ui:fragment>

								<!-- re-staining needed = orange -->
								<ui:fragment rendered="#{task.taskStatus.reStainingNeeded}">
									<i style="margin-left: 5px;" class="fa fa-image icon-orange"
										title="#{msg['body.worklist.navigation.activtasks.restaining']}" />
								</ui:fragment>

								<!--  no staining needed = purple -->
								<ui:fragment rendered="#{task.taskStatus.stayInStainingList}">
									<i style="margin-left: 5px;" class="fa fa-image icon-purple"
										title="#{msg['body.worklist.navigation.activtasks.stainingPhase']}" />
								</ui:fragment>


								<!-- diagnosis needed -->
								<!-- diagnosis needed = green -->
								<ui:fragment rendered="#{task.taskStatus.diagnosisNeeded}">
									<i style="margin-left: 5px;" class="fa fa-eye icon-green"
										title="#{msg['body.worklist.navigation.activtasks.diagnosis']}" />
								</ui:fragment>

								<!-- re-diagnosis needed = orange -->
								<ui:fragment rendered="#{task.taskStatus.reDiagnosisNeeded}">
									<i style="margin-left: 5px;" class="fa fa-eye icon-orange"
										title="#{msg['body.worklist.navigation.activtasks.rediagnosis'] }" />
								</ui:fragment>

								<!-- no diagnosis needed = purple -->
								<ui:fragment rendered="#{task.taskStatus.stayInDiagnosisList}">
									<i style="margin-left: 5px;" class="fa fa-eye icon-purple"
										title="#{msg['body.worklist.navigation.activtasks.diagnosisPhase'] }" />
								</ui:fragment>

								<!-- notification needed -->
								<!-- notification need = green -->
								<ui:fragment rendered="#{task.taskStatus.notificationNeeded}">
									<i style="margin-left: 5px;" class="fa fa-volume-up icon-green"
										title="#{msg['body.worklist.navigation.activtasks.diagnosis']}" />
								</ui:fragment>

								<!-- stay in phase = purple -->
								<ui:fragment
									rendered="#{task.taskStatus.stayInNotificationList}">
									<i style="margin-left: 5px;"
										class="fa fa-volume-up icon-purple"
										title="#{msg['body.worklist.navigation.activtasks.rediagnosis'] }" />
								</ui:fragment>
							</h:panelGroup>
						</p:commandLink>

						<p:commandLink partialSubmit="true" process="@this"
							actionListener="#{dialogHandlerAction.councilDialogHandler.initAndPrepareBean(task)}"
							update="navigationForm:patientList contentForm headerForm"
							styleClass="noUnderlineAtLink">
							<!-- council lending mta -->
							<ui:fragment rendered="#{task.taskStatus.councilLendingMTA}">
								<i style="margin-left: 5px;"
									class="fa  fa-stethoscope icon-orange"
									title="#{msg['body.worklist.navigation.activtasks.councilLendingMTA']}" />
							</ui:fragment>
							<!-- council lending secretary -->
							<ui:fragment
								rendered="#{task.taskStatus.councilLendingSecretary}">
								<i style="margin-left: 5px;"
									class="fa  fa-stethoscope icon-orange"
									title="#{msg['body.worklist.navigation.activtasks.councilLendingSecretary']}" />
							</ui:fragment>
							<!-- council pending -->
							<ui:fragment rendered="#{task.taskStatus.councilPending}">
								<i style="margin-left: 5px;" class="fa  fa-stethoscope icon-red"
									title="#{msg['body.worklist.navigation.activtasks.councilPending']}" />
							</ui:fragment>
							<!-- council completed -->
							<ui:fragment rendered="#{task.taskStatus.councilCompleted}">
								<i style="margin-left: 5px;"
									class="fa  fa-stethoscope icon-purple"
									title="#{msg['body.worklist.navigation.activtasks.councilCompleted']}" />
							</ui:fragment>
						</p:commandLink>

						<!-- Pendings completed -->
						<h:panelGroup rendered="#{task.taskStatus.finalizeable}">
							<i style="margin-left: 5px;"
								class="fa fa-check-circle icon-green"
								title="#{msg['body.worklist.navigation.activtasks.pendencies']}" />
						</h:panelGroup>

						<!-- archived -->
						<h:panelGroup rendered="#{task.finalized}">
							<i style="margin-left: 5px;" class="fa fa-archive"
								title="#{msg['body.worklist.navigation.activtasks.archived']}" />
						</h:panelGroup>

						<br />
					</p:repeat>

					<h:outputLabel value="#{msg['body.worklist.navigation.tasks']}"
						rendered="#{patient.hasNoneActiveTasks() and worklistViewHandlerAction.worklist.showNoneActiveTasks}" />

					<h:panelGroup
						rendered="#{patient.hasNoneActiveTasks() and worklistViewHandlerAction.worklist.showNoneActiveTasks}">
						<p:repeat var="task" value="#{patient.getNoneActiveTasks()}">
							<p:commandLink
								actionListener="#{worklistViewHandlerAction.onSelectTaskAndPatient(task)}"
								update="navigationForm:patientList contentForm headerForm"
								styleClass="noUnderlineAtLink">
								<h:outputLabel value="#{task.taskID}"
									style="#{globalEditViewHandler.selectedTask eq task ? 'text-decoration: underline;' : ''}" />
							</p:commandLink>
							<br />
						</p:repeat>
					</h:panelGroup>
				</h:panelGrid>
			</p:column>

		</p:dataTable>
	</p:scrollPanel>

	<!-- scrollspeed of scrollpane -->
	<script type="text/javascript">
     $(document).ready(function () {
        $("#navigationForm\\:patientNavigationScroll").jScrollPane({mouseWheelSpeed: 100});
     });
	</script>

	<p:contextMenu for="patientList">
		<p:menuitem value="Entfernen" icon="ui-icon-close"
			actionListener="#{worklistViewHandlerAction.removeFromWorklist(globalEditViewHandler.selectedPatient)}"
			update="navigationForm:patientList contentForm headerForm" />
	</p:contextMenu>
</ui:composition>
